<!DOCTYPE html>
<head>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parete TAKTAK® - Sistema Professionale</title>
    <link rel="stylesheet" href="/static/css/style.css?v=3.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <!-- ✅ SISTEMA DI AUTENTICAZIONE GLOBALE -->
    <script src="/static/js/auth.js"></script>
    <script>
        // Inizializza l'autenticazione per questa pagina (protetta)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('� Verifica autenticazione per dashboard...');
            
            // Verifica che l'utente sia autenticato
            if (!window.authManager.isLoggedIn()) {
                console.log('❌ Utente non autenticato - redirect al login');
                window.location.href = '/login';
                return;
            }
            
            console.log('✅ Utente autenticato - caricamento dashboard');
        });
    </script>

    <div id="app">
        <!-- Header with Navigation -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <!-- Logo and Brand -->
                    <div class="logo-section">
                        <div class="logo-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="logo-text">
                            <h1>Parete TAKTAK<sup>®</sup></h1>
                            <span class="subtitle">Sistema Professionale di Progettazione</span>
                        </div>
                    </div>
                    
                    <!-- Navigation Menu -->
                    <nav class="main-nav">
                        <div class="nav-item active" data-section="app">
                            <i class="fas fa-play-circle"></i>
                            <span>Applicazione</span>
                        </div>
                        <div class="nav-item" data-section="library">
                            <i class="fas fa-cog"></i>
                            <span>Impostazioni Globali</span>
                        </div>
                        <div class="nav-item" data-section="settings">
                            <i class="fas fa-history"></i>
                            <span>Progetti Passati</span>
                        </div>
                    </nav>
                    
                    <!-- User Section - Semplice -->
                    <div class="user-section-simple" id="userSectionSimple">
                        <div class="user-info-simple" id="userInfoSimple">
                            <div class="user-avatar-simple">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="user-name-simple" id="userNameSimple">Caricamento...</span>
                            <div class="user-menu-toggle" id="userMenuToggle">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        
                        <!-- Menu Semplice -->
                        <div class="user-menu-simple" id="userMenuSimple" style="display: none;">
                            <button class="logout-btn-simple" id="logoutBtnSimple">
                                <i class="fas fa-sign-out-alt"></i>
                                Disconnetti
                            </button>
                        </div>
                    </div>
                    
                    <!-- Header Stats (shown only in app section) -->
                    <div class="header-stats" id="headerStats" style="display: none;">
                        <div class="stat-item">
                            <span class="stat-value" id="statStandard">0</span>
                            <span class="stat-label">Blocchi Standard</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="statCustom">0</span>
                            <span class="stat-label">Pezzi Custom</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="statEfficiency">0%</span>
                            <span class="stat-label">Efficienza</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Container -->
        <main class="main-content">
            <div class="container">
                
                <!-- APPLICATION SECTION -->
                <div id="appSection" class="content-section active">
                    <!-- Step 1: Upload -->
                    <section class="step-section" id="uploadSection">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-info">
                                <h2>Carica File CAD</h2>
                                <p>Seleziona o trascina il file CAD contenente la parete da costruire</p>
                            </div>
                        </div>
                        
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3>Trascina qui il file CAD</h3>
                                <p>oppure <button type="button" class="link-button" id="selectFileBtn">seleziona file</button></p>
                                <div class="upload-info">
                                    <div class="format-support">
                                        <strong>Formati supportati:</strong>
                                        <ul>
                                            <li><i class="fas fa-check-circle text-success"></i> <strong>SVG</strong> - Supporto completo</li>
                                            <li><i class="fas fa-check-circle text-success"></i> <strong>DXF</strong> - Supporto completo</li>
                                            <li><i class="fas fa-check-circle text-success"></i> <strong>DWG</strong> - AutoCAD </li>
                                        </ul>
                                        
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="fileInput" accept=".svg,.dwg,.dxf" style="display: none;">
                        </div>
                        
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-preview">
                                <div class="file-icon">
                                    <i class="fas fa-file-check"></i>
                                </div>
                                <div class="file-details">
                                    <div class="file-name" id="fileName"></div>
                                    <div class="file-meta" id="fileMeta"></div>
                                </div>
                                <button type="button" class="btn-icon" id="removeFile" title="Rimuovi file">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- NEW Step 2: Preview -->
                    <section class="step-section" id="previewSection" style="display: none;">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-info">
                                <h2>Anteprima Conversione</h2>
                                <p>Verifica che la conversione del file sia corretta prima di procedere</p>
                            </div>
                        </div>
                        
                        <div class="preview-container-main">
                            <!-- Preview Image -->
                            <div class="preview-card-main">
                                <div class="card-header">
                                    <h3><i class="fas fa-eye"></i> Anteprima Parete Convertita</h3>
                                    <div class="preview-actions">
                                        <button type="button" class="btn-icon" id="zoomInPreview" title="Ingrandisci">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button type="button" class="btn-icon" id="zoomOutPreview" title="Riduci">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <button type="button" class="btn-icon" id="centerPreview" title="Centra">
                                            <i class="fas fa-crosshairs"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="image-container" id="previewImageContainer">
                                    <div class="preview-loading" id="previewLoadingMain">
                                        <div class="spinner"></div>
                                        <p>Conversione file in corso...</p>
                                    </div>
                                    <canvas id="previewCanvas" style="display: none;"></canvas>
                                </div>
                            </div>
                            
                            <!-- Measurements Panel -->
                            <div class="measurements-panel">
                                <div class="measurements-header">
                                    <h3><i class="fas fa-ruler-combined"></i> Dimensioni Rilevate</h3>
                                </div>
                                <div class="measurements-content" id="measurementsContent">
                                    <div class="measurement-loading" id="measurementsLoading">
                                        <i class="fas fa-calculator"></i>
                                        <span>Calcolo dimensioni...</span>
                                    </div>
                                    <div class="measurements-data" id="measurementsData" style="display: none;">
                                        <div class="measurement-item">
                                            <span class="measurement-label">Area Totale:</span>
                                            <span class="measurement-value" id="totalArea">-- m²</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Larghezza Massima:</span>
                                            <span class="measurement-value" id="maxWidth">-- mm</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Altezza Massima:</span>
                                            <span class="measurement-value" id="maxHeight">-- mm</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Aperture Rilevate:</span>
                                            <span class="measurement-value" id="aperturesCount">-- elementi</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Perimetro:</span>
                                            <span class="measurement-value" id="wallPerimeter">-- mm</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Geometria:</span>
                                            <span class="measurement-value" id="geometryType">-- tipo</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Conversion Details -->
                                <div class="conversion-details" id="conversionDetails" style="display: none;">
                                    <div class="conversion-header">
                                        <h4><i class="fas fa-info-circle"></i> Dettagli Conversione</h4>
                                    </div>
                                    <div class="conversion-info">
                                        <div class="detail-item">
                                            <span class="detail-label">File Originale:</span>
                                            <span class="detail-value" id="originalFileName">--</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Formato:</span>
                                            <span class="detail-value" id="fileFormat">--</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Dimensione File:</span>
                                            <span class="detail-value" id="fileSize">--</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Stato Conversione:</span>
                                            <span class="detail-value status-success" id="conversionStatus">
                                                <i class="fas fa-check-circle"></i> Completata
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Validation Messages -->
                                <div class="validation-messages" id="validationMessages">
                                    <!-- Messages will be populated by JS -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step Actions -->
                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" id="backToUploadFromPreview">
                                <i class="fas fa-arrow-left"></i> Indietro
                            </button>
                            <button type="button" class="btn btn-outline" id="reprocessFile">
                                <i class="fas fa-sync-alt"></i> Riconverti File
                            </button>
                            <button type="button" class="btn btn-primary" id="acceptPreview">
                                <i class="fas fa-check"></i> Conferma e Continua
                            </button>
                        </div>
                    </section>

                    <!-- Step 3: Project Parameters (formerly Step 2) -->
                    <section class="step-section" id="projectParamsSection" style="display: none;">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <div class="step-info">
                                <h2>Parametri di Progetto</h2>
                                <p>Inserisci le specifiche tecniche per il calcolo automatico delle misure</p>
                            </div>
                        </div>
                        
                        <div class="config-grid project-params-grid">
                            <!-- Material Configuration -->
                            <div class="config-card material-config-card">
                                <label>
                                    <i class="fas fa-layer-group"></i>
                                    Configurazione Materiale
                                </label>
                                <div class="param-row">
                                    <label for="materialType">Tipologia Materiale:</label>
                                    <select id="materialType" class="param-input">
                                        <option value="melamine">Melamina</option>
                                        <option value="mdf">MDF</option>
                                        <option value="chipboard">Truciolato</option>
                                        <option value="plywood">Multistrato</option>
                                        <option value="custom">Personalizzato</option>
                                    </select>
                                </div>
                                <div class="param-row">
                                    <label for="materialThickness">Spessore Materiale (mm):</label>
                                    <input type="number" id="materialThickness" class="param-input" value="18" min="10" max="50" step="1">
                                    <span class="param-help">*Influenza calcolo spessore chiusure</span>
                                </div>
                                <div class="param-row">
                                    <label for="materialDensity">Densità (kg/m³):</label>
                                    <input type="number" id="materialDensity" class="param-input" value="650" min="400" max="1000" step="10">
                                </div>
                            </div>

                            <!-- Guide Configuration -->
                            <div class="config-card guide-config-card">
                                <label>
                                    <i class="fas fa-ruler-horizontal"></i>
                                    Configurazione Guide
                                </label>
                                <div class="param-row">
                                    <label>Tipologia Guide da Utilizzare:</label>
                                    <div class="guide-selector">
                                        <input type="radio" id="guide50" name="guideType" value="50" class="guide-radio">
                                        <label for="guide50" class="guide-option">
                                            <span class="guide-size">50mm</span>
                                            <span class="guide-desc">Guide Strette</span>
                                        </label>
                                        
                                        <input type="radio" id="guide75" name="guideType" value="75" class="guide-radio" checked>
                                        <label for="guide75" class="guide-option active">
                                            <span class="guide-size">75mm</span>
                                            <span class="guide-desc">Guide Standard</span>
                                        </label>
                                        
                                        <input type="radio" id="guide100" name="guideType" value="100" class="guide-radio">
                                        <label for="guide100" class="guide-option">
                                            <span class="guide-size">100mm</span>
                                            <span class="guide-desc">Guide Larghe</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="param-row">
                                    <label for="guideDepth">Profondità Guide (mm):</label>
                                    <input type="number" id="guideDepth" class="param-input" value="25" min="15" max="50" step="1">
                                </div>
                            </div>

                            <!-- Wall Position Configuration -->
                            <div class="config-card wall-position-card">
                                <label>
                                    <i class="fas fa-home"></i>
                                    Posizione Parete e Punti di Appoggio
                                </label>
                                <div class="param-row">
                                    <label>Tipologia Parete:</label>
                                    <div class="wall-type-selector">
                                        <input type="radio" id="wallNew" name="wallType" value="new" class="wall-radio" checked>
                                        <label for="wallNew" class="wall-option active">
                                            <i class="fas fa-plus-circle"></i>
                                            <span>Parete Nuova</span>
                                            <small>Parete indipendente</small>
                                        </label>
                                        
                                        <input type="radio" id="wallAttached" name="wallType" value="attached" class="wall-radio">
                                        <label for="wallAttached" class="wall-option">
                                            <i class="fas fa-link"></i>
                                            <span>Parete Attaccata</span>
                                            <small>Appoggiata a muri esistenti</small>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Attachment Points (shown only for attached walls) -->
                                <div id="attachmentPoints" class="attachment-config" style="display: none;">
                                    <div class="param-row">
                                        <label>Lati di Appoggio:</label>
                                        <div class="attachment-selector">
                                            <label class="attachment-point">
                                                <input type="checkbox" id="attachLeft" class="attachment-checkbox">
                                                <span class="attachment-label">
                                                    <i class="fas fa-arrow-left"></i> Sinistra
                                                </span>
                                            </label>
                                            <label class="attachment-point">
                                                <input type="checkbox" id="attachRight" class="attachment-checkbox">
                                                <span class="attachment-label">
                                                    <i class="fas fa-arrow-right"></i> Destra
                                                </span>
                                            </label>
                                            <label class="attachment-point">
                                                <input type="checkbox" id="attachTop" class="attachment-checkbox">
                                                <span class="attachment-label">
                                                    <i class="fas fa-arrow-up"></i> Alto
                                                </span>
                                            </label>
                                            <label class="attachment-point">
                                                <input type="checkbox" id="attachBottom" class="attachment-checkbox">
                                                <span class="attachment-label">
                                                    <i class="fas fa-arrow-down"></i> Basso
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="param-help-box">
                                        <i class="fas fa-info-circle"></i>
                                        <span><strong>Importante:</strong> L'algoritmo inizierà il posizionamento dei blocchi dal lato fissato selezionato</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Ceiling and Moretti Configuration -->
                            <div class="config-card ceiling-config-card">
                                <label>
                                    <i class="fas fa-ruler-vertical"></i>
                                    Altezze e Moretti
                                </label>
                                <div class="param-row">
                                    <label for="ceilingHeight">Altezza Soffitto (mm):</label>
                                    <input type="number" id="ceilingHeight" class="param-input" value="2700" min="2200" max="4000" step="10">
                                    <span class="param-help">Altezza dal pavimento al soffitto</span>
                                </div>
                                <div class="param-row">
                                    <label>
                                        <input type="checkbox" id="enableMoretti" class="param-checkbox" checked>
                                        Calcolo Automatico Moretti
                                    </label>
                                    <span class="param-help">Per pareti che non raggiungono il soffitto</span>
                                </div>
                                <div id="morettiNote" class="param-note">
                                    <i class="fas fa-calculator"></i>
                                    <span>I moretti verranno calcolati automaticamente in base all'altezza parete e del soffitto</span>
                                </div>
                            </div>

                            <!-- Advanced Options -->
                            <div class="config-card advanced-config-card">
                                <label>
                                    <i class="fas fa-cogs"></i>
                                    Opzioni Avanzate
                                </label>
                                <div class="param-row">
                                    <label>
                                        <input type="checkbox" id="enableAutoMeasurements" class="param-checkbox" checked>
                                        Calcoli Automatici Attivati
                                    </label>
                                    <span class="param-help">Calcolo spessore chiusure e parametri</span>
                                </div>
                                <div class="param-row">
                                    <label>
                                        <input type="checkbox" id="enableCostEstimation" class="param-checkbox" checked>
                                        Stima Costi Materiali
                                    </label>
                                    <span class="param-help">Calcolo automatico fabbisogno e costi</span>
                                </div>
                            </div>
                        </div>

                        <!-- Parameters Summary -->
                        <div class="params-summary" id="paramsSummary">
                            <div class="summary-header">
                                <i class="fas fa-clipboard-check"></i>
                                <span>Riepilogo Parametri Impostati</span>
                            </div>
                            <div class="summary-content" id="paramsSummaryContent">
                                <div class="summary-item">
                                    <span class="summary-label">Materiale:</span>
                                    <span class="summary-value" id="summaryMaterial">Melamina 18mm</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Guide:</span>
                                    <span class="summary-value" id="summaryGuides">75mm Standard</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Tipologia:</span>
                                    <span class="summary-value" id="summaryWallType">Parete Nuova</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Soffitto:</span>
                                    <span class="summary-value" id="summaryCeiling">2700mm</span>
                                </div>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" id="backToUpload">
                                <i class="fas fa-arrow-left"></i> Indietro
                            </button>
                            <button type="button" class="btn btn-primary" id="proceedToConfig">
                                <i class="fas fa-arrow-right"></i> Continua
                            </button>
                        </div>
                    </section>

                    <!-- Step 4: Configuration (formerly Step 3) -->
                    <section class="step-section" id="configSection" style="display: none;">
                        <div class="step-header">
                            <div class="step-number">4</div>
                            <div class="step-info">
                                <h2>Configurazione Blocchi</h2>
                                <p>Personalizza le impostazioni di packing per ottimizzare il risultato</p>
                            </div>
                        </div>
                        
                        <div class="config-grid">
                            <!-- Active Block Configuration Display -->
                            <div class="config-card active-blocks-card">
                                <label>
                                    <i class="fas fa-cubes"></i>
                                    Blocchi Configurati
                                    <button type="button" class="edit-blocks-btn" id="editBlocksBtn" onclick="openBlockLibrary()" style="display: none;">
                                        <i class="fas fa-edit"></i> Modifica in Libreria
                                    </button>
                                </label>
                                <div class="active-blocks-preview" id="activeBlocksPreview">
                                    <div class="active-block-item">
                                        <div class="block-mini-preview block-type1"></div>
                                        <div class="block-details">
                                            <span class="block-name">Tipo 1</span>
                                            <span class="block-dims" id="activeBlock1Dims">1239×495×100 mm</span>
                                        </div>
                                    </div>
                                    <div class="active-block-item">
                                        <div class="block-mini-preview block-type2"></div>
                                        <div class="block-details">
                                            <span class="block-name">Tipo 2</span>
                                            <span class="block-dims" id="activeBlock2Dims">826×495×100 mm</span>
                                        </div>
                                    </div>
                                    <div class="active-block-item">
                                        <div class="block-mini-preview block-type3"></div>
                                        <div class="block-details">
                                            <span class="block-name">Tipo 3</span>
                                            <span class="block-dims" id="activeBlock3Dims">413×495×100 mm</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="blocks-usage-info">
                                    <small id="blocksUsageInfo"><i class="fas fa-info-circle"></i> Questi blocchi verranno utilizzati per il packing della parete</small>
                                    <small id="blocksLockInfo" style="display: none;"><i class="fas fa-lock"></i> Le dimensioni dei blocchi non possono essere modificate dopo aver caricato un file. Per cambiarle, inizia un nuovo progetto.</small>
                                </div>
                            </div>
                            
                            <div class="config-card">
                                <label for="projectName">
                                    <i class="fas fa-project-diagram"></i>
                                    Nome Progetto
                                </label>
                                <input type="text" id="projectName" value="Progetto Parete" placeholder="Inserisci nome progetto">
                            </div>
                            
                            <div class="config-card">
                                <label for="rowOffset">
                                    <i class="fas fa-arrows-alt-h"></i>
                                    Offset Righe Dispari (mm)
                                </label>
                                <div class="slider-container">
                                    <input type="range" id="rowOffset" min="0" max="1239" value="826" step="1">
                                    <div class="slider-value" id="rowOffsetValue">826 mm</div>
                                </div>
                                <div class="slider-presets">
                                    <button type="button" class="preset-btn" data-value="0">0</button>
                                    <button type="button" class="preset-btn active" data-value="826">826</button>
                                    <button type="button" class="preset-btn" data-value="413">413</button>
                                    <button type="button" class="preset-btn" data-value="1239">1239</button>
                                </div>
                            </div>
                            
                            <div class="config-card">
                                <label for="blockWidths">
                                    <i class="fas fa-ruler-horizontal"></i>
                                    Dimensioni Blocchi (mm)
                                </label>
                                <input type="text" id="blockWidths" value="1239,826,413" placeholder="es: 1239,826,413">
                                <small>Larghezze blocchi standard separate da virgola</small>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="btn btn-primary" id="processBtn">
                                <i class="fas fa-cogs"></i>
                                <span>Calcola Packing</span>
                            </button>
                            <button type="button" class="btn btn-secondary" id="backToUpload">
                                <i class="fas fa-arrow-left"></i>
                                <span>Torna a Upload</span>
                            </button>
                        </div>
                    </section>

                    <!-- Step 5: Results (formerly Step 4) -->
                    <section class="step-section" id="resultsSection" style="display: none;">
                        <div class="step-header">
                            <div class="step-number">5</div>
                            <div class="step-info">
                                <h2>Risultati Packing</h2>
                                <p>Visualizza il layout calcolato e scarica i risultati</p>
                            </div>
                        </div>
                        
                        <div class="results-grid">
                            <!-- Preview Area -->
                            <div class="preview-card">
                                <div class="card-header">
                                    <h3><i class="fas fa-eye"></i> Preview Parete</h3>
                                    <div class="preview-controls">
                                        <button type="button" class="btn-icon" id="refreshPreview" title="Aggiorna preview">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button type="button" class="btn-icon" id="fullscreenPreview" title="Schermo intero">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="preview-container" id="previewContainer">
                                    <div class="preview-loading" id="previewLoading">
                                        <div class="spinner"></div>
                                        <p>Generazione preview...</p>
                                    </div>
                                    <img id="previewImage" style="display: none;" alt="Preview parete">
                                </div>
                                
                                <!-- Configuration Info Card - Below Preview -->
                                <div class="configuration-card" id="configurationCard" style="display: none; margin-top: 20px;">
                                    <h3>
                                        <i class="fas fa-cog"></i> 
                                        Riassunto Configurazione Progetto
                                    </h3>
                                    <div class="config-info-grid">
                                        <div class="config-section" id="materialSection" style="display: none;">
                                            <h4>Materiale</h4>
                                            <div id="materialInfo"></div>
                                        </div>
                                        <div class="config-section" id="guideSection" style="display: none;">
                                            <h4>Guide</h4>
                                            <div id="guideInfo"></div>
                                        </div>
                                        <div class="config-section" id="blockSection" style="display: none;">
                                            <h4>Blocchi</h4>
                                            <div id="blockInfo"></div>
                                        </div>
                                        <div class="config-section" id="morettiSection" style="display: none;">
                                            <h4>Moretti</h4>
                                            <div id="morettiInfo"></div>
                                        </div>
                                        <div class="config-section" id="constructionSection" style="display: none;">
                                            <h4>Costruzione</h4>
                                            <div id="constructionInfo"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Summary Tables -->
                            <div class="summary-cards">
                                <!-- Standard Blocks -->
                                <div class="summary-card">
                                    <h3>
                                        <i class="fas fa-cubes"></i> 
                                        <span id="standardBlocksTitle">Blocchi Standard (Raggruppati)</span>
                                        <span id="customBlocksIndicator" class="custom-blocks-indicator" style="display: none;">
                                            <i class="fas fa-tools" title="Dimensioni personalizzate"></i>
                                        </span>
                                    </h3>
                                    <div class="table-container">
                                        <table id="standardTable">
                                            <thead>
                                                <tr>
                                                    <th>Categoria</th>
                                                    <th>Quantità</th>
                                                    <th>Dimensioni</th>
                                                    <th>Numerazione</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Custom Pieces -->
                                <div class="summary-card">
                                    <h3><i class="fas fa-puzzle-piece"></i> Pezzi Custom (Raggruppati)</h3>
                                    <div class="table-container">
                                        <table id="customTable">
                                            <thead>
                                                <tr>
                                                    <th>Categoria</th>
                                                    <th>Quantità</th>
                                                    <th>Dimensioni</th>
                                                    <th>Numerazione</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="btn btn-success" id="downloadPDF">
                                <i class="fas fa-file-pdf"></i>
                                <span>Scarica PDF</span>
                            </button>
                            <button type="button" class="btn btn-primary" id="downloadDXF">
                                <i class="fas fa-drafting-compass"></i>
                                <span>Scarica DXF</span>
                            </button>
                            <button type="button" class="btn btn-primary" id="downloadJSON">
                                <i class="fas fa-file-code"></i>
                                <span>Scarica JSON</span>
                            </button>
                            <button type="button" class="btn btn-secondary" id="reconfigureBtn">
                                <i class="fas fa-cogs"></i>
                                <span>Riconfigurazione</span>
                            </button>
                            <button type="button" class="btn btn-outline" id="newProjectBtn">
                                <i class="fas fa-plus"></i>
                                <span>Nuovo Progetto</span>
                            </button>
                        </div>
                    </section>
                </div>
                
                <!-- LIBRARY SECTION -->
                <div id="librarySection" class="content-section">
                    <div class="page-header">
                        <div class="page-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="page-info">
                            <h1>Impostazioni Globali</h1>
                            <p>Configurazioni generali del sistema e personalizzazioni</p>
                        </div>
                    </div>
                    
                    <div class="features-grid">
                        <!-- Block Dimensions Configuration Card -->
                        <div class="feature-card block-dimensions-card" onclick="toggleBlockDimensionsPanel()">
                            <div class="feature-icon">
                                <i class="fas fa-ruler-combined"></i>
                            </div>
                            <div class="feature-content">
                                <h3>Dimensioni Blocchi Standard <i class="fas fa-chevron-down expand-icon" id="blockDimensionsExpandIcon"></i></h3>
                                <p>Configura le misure dei 3 tipi di blocchi standard</p>
                                
                                <!-- Block Dimensions Panel (Initially Hidden) -->
                                <div class="block-dimensions-panel" id="blockDimensionsPanel" style="display: none;">
                                    
                                    <!-- Block Type 1 -->
                                    <div class="block-group">
                                        <h4><i class="fas fa-cube"></i> Blocco Standard Tipo 1</h4>
                                        <div class="dimensions-controls">
                                            <div class="dimension-control">
                                                <label for="block1Width">Larghezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block1Width" value="1239" min="400" max="1500" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="dimension-control">
                                                <label for="block1Height">Altezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block1Height" value="495" min="200" max="800" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="dimension-control">
                                                <label for="block1Depth">Profondità (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block1Depth" value="100" min="50" max="300" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="block-preview">
                                            <div class="preview-block-3d" id="previewBlock1">
                                                <span class="block-label">Tipo 1</span>
                                            </div>
                                            <div class="block-info">
                                                <span class="block-volume" id="block1Volume">Volume: 1.000 L</span>
                                                <span class="block-weight" id="block1Weight">Peso: ~2.4 kg</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Block Type 2 -->
                                    <div class="block-group">
                                        <h4><i class="fas fa-cube"></i> Blocco Standard Tipo 2</h4>
                                        <div class="dimensions-controls">
                                            <div class="dimension-control">
                                                <label for="block2Width">Larghezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block2Width" value="826" min="400" max="1500" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="dimension-control">
                                                <label for="block2Height">Altezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block2Height" value="495" min="200" max="800" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="dimension-control">
                                                <label for="block2Depth">Profondità (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block2Depth" value="100" min="50" max="300" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="block-preview">
                                            <div class="preview-block-3d" id="previewBlock2">
                                                <span class="block-label">Tipo 2</span>
                                            </div>
                                            <div class="block-info">
                                                <span class="block-volume" id="block2Volume">Volume: 0.750 L</span>
                                                <span class="block-weight" id="block2Weight">Peso: ~1.8 kg</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Block Type 3 -->
                                    <div class="block-group">
                                        <h4><i class="fas fa-cube"></i> Blocco Standard Tipo 3</h4>
                                        <div class="dimensions-controls">
                                            <div class="dimension-control">
                                                <label for="block3Width">Larghezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block3Width" value="413" min="200" max="800" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="dimension-control">
                                                <label for="block3Height">Altezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block3Height" value="495" min="200" max="800" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="dimension-control">
                                                <label for="block3Depth">Profondità (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block3Depth" value="100" min="50" max="300" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="block-preview">
                                            <div class="preview-block-3d" id="previewBlock3">
                                                <span class="block-label">Tipo 3</span>
                                            </div>
                                            <div class="block-info">
                                                <span class="block-volume" id="block3Volume">Volume: 0.500 L</span>
                                                <span class="block-weight" id="block3Weight">Peso: ~1.2 kg</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Comparison Section -->
                                    <div class="blocks-comparison">
                                        <h4><i class="fas fa-chart-bar"></i> Confronto Blocchi</h4>
                                        <div class="comparison-grid">
                                            <div class="comparison-item">
                                                <strong>Tipo 1</strong>
                                                <div class="comparison-bar">
                                                    <div class="bar bar-type1" id="comparisonBar1"></div>
                                                </div>
                                                <span id="comparisonRatio1">100%</span>
                                            </div>
                                            <div class="comparison-item">
                                                <strong>Tipo 2</strong>
                                                <div class="comparison-bar">
                                                    <div class="bar bar-type2" id="comparisonBar2"></div>
                                                </div>
                                                <span id="comparisonRatio2">75%</span>
                                            </div>
                                            <div class="comparison-item">
                                                <strong>Tipo 3</strong>
                                                <div class="comparison-bar">
                                                    <div class="bar bar-type3" id="comparisonBar3"></div>
                                                </div>
                                                <span id="comparisonRatio3">50%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="block-actions">
                                        <button class="preset-btn" onclick="event.stopPropagation(); applyBlockPreset('standard')">
                                            <i class="fas fa-undo"></i> Standard
                                        </button>
                                        <button class="preset-btn" onclick="event.stopPropagation(); applyBlockPreset('metric')">
                                            <i class="fas fa-ruler"></i> Metriche
                                        </button>
                                        <button class="preset-btn" onclick="event.stopPropagation(); applyBlockPreset('compact')">
                                            <i class="fas fa-compress"></i> Compatti
                                        </button>
                                        <button class="preset-btn reset-btn" onclick="event.stopPropagation(); resetToSystemDefaults()">
                                            <i class="fas fa-cogs"></i> Reset Sistema
                                        </button>
                                        <button class="save-btn primary-btn" onclick="event.stopPropagation(); saveBlockDimensions()">
                                            <i class="fas fa-save"></i> Salva Dimensioni
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Color Theme Customization Card -->
                        <div class="feature-card color-theme-card" onclick="toggleColorThemePanel()">
                            <div class="feature-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="feature-content">
                                <h3>Temi Personalizzati <i class="fas fa-chevron-down expand-icon" id="colorThemeExpandIcon"></i></h3>
                                <p>Personalizza i colori dei blocchi e degli elementi</p>
                                
                                <!-- Color Settings Panel (Initially Hidden) -->
                                <div class="color-settings-panel" id="colorSettingsPanel" style="display: none;">
                                    <div class="color-group">
                                        <h4><i class="fas fa-cubes"></i> Blocchi Standard</h4>
                                        <div class="color-controls">
                                            <div class="color-control">
                                                <label for="standardBlockColor">Colore Riempimento:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="standardBlockColor" value="#E5E7EB" class="color-picker">
                                                    <input type="text" id="standardBlockColorText" value="#E5E7EB" class="color-text">
                                                </div>
                                            </div>
                                            <div class="color-control">
                                                <label for="standardBlockBorder">Colore Bordo:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="standardBlockBorder" value="#374151" class="color-picker">
                                                    <input type="text" id="standardBlockBorderText" value="#374151" class="color-text">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="color-group">
                                        <h4><i class="fas fa-door-open"></i> Porte e Finestre</h4>
                                        <div class="color-controls">
                                            <div class="color-control">
                                                <label for="doorWindowColor">Colore Riempimento:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="doorWindowColor" value="#FEE2E2" class="color-picker">
                                                    <input type="text" id="doorWindowColorText" value="#FEE2E2" class="color-text">
                                                </div>
                                            </div>
                                            <div class="color-control">
                                                <label for="doorWindowBorder">Colore Bordo:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="doorWindowBorder" value="#DC2626" class="color-picker">
                                                    <input type="text" id="doorWindowBorderText" value="#DC2626" class="color-text">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="color-group">
                                        <h4><i class="fas fa-vector-square"></i> Contorno Parete</h4>
                                        <div class="color-controls">
                                            <div class="color-control">
                                                <label for="wallOutlineColor">Colore Contorno:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="wallOutlineColor" value="#1E40AF" class="color-picker">
                                                    <input type="text" id="wallOutlineColorText" value="#1E40AF" class="color-text">
                                                </div>
                                            </div>
                                            <div class="color-control">
                                                <label for="wallLineWidth">Spessore Linea:</label>
                                                <div class="range-input-group">
                                                    <input type="range" id="wallLineWidth" min="1" max="5" value="2" class="range-slider">
                                                    <span class="range-value">2px</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="color-group">
                                        <h4><i class="fas fa-puzzle-piece"></i> Pezzi Custom</h4>
                                        <div class="color-controls">
                                            <div class="color-control">
                                                <label for="customPieceColor">Colore Riempimento:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="customPieceColor" value="#F3E8FF" class="color-picker">
                                                    <input type="text" id="customPieceColorText" value="#F3E8FF" class="color-text">
                                                </div>
                                            </div>
                                            <div class="color-control">
                                                <label for="customPieceBorder">Colore Bordo:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="customPieceBorder" value="#7C3AED" class="color-picker">
                                                    <input type="text" id="customPieceBorderText" value="#7C3AED" class="color-text">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview Section -->
                                    <div class="color-preview-section">
                                        <h4><i class="fas fa-eye"></i> Anteprima Colori</h4>
                                        <div class="color-preview-grid">
                                            <div class="preview-item">
                                                <div class="preview-block standard-block" id="previewStandardBlock"></div>
                                                <span>Blocco Standard</span>
                                            </div>
                                            <div class="preview-item">
                                                <div class="preview-block door-window-block" id="previewDoorWindow"></div>
                                                <span>Porta/Finestra</span>
                                            </div>
                                            <div class="preview-item">
                                                <div class="preview-block custom-piece-block" id="previewCustomPiece"></div>
                                                <span>Pezzo Custom</span>
                                            </div>
                                            <div class="preview-item">
                                                <div class="preview-outline" id="previewWallOutline"></div>
                                                <span>Contorno</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="color-actions">
                                        <button class="preset-btn" onclick="event.stopPropagation(); applyPreset('default')">
                                            <i class="fas fa-undo"></i> Default
                                        </button>
                                        <button class="preset-btn" onclick="event.stopPropagation(); applyPreset('highContrast')">
                                            <i class="fas fa-adjust"></i> Alto Contrasto
                                        </button>
                                        <button class="preset-btn" onclick="event.stopPropagation(); applyPreset('colorful')">
                                            <i class="fas fa-rainbow"></i> Colorato
                                        </button>
                                        <button class="save-btn primary-btn" onclick="event.stopPropagation(); saveColorTheme()">
                                            <i class="fas fa-save"></i> Salva Tema
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SETTINGS SECTION -->
                <div id="settingsSection" class="content-section">
                    <div class="page-header">
                        <div class="page-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="page-info">
                            <h1>Progetti Passati</h1>
                            <p>Archivio e gestione dei progetti completati</p>
                        </div>
                    </div>
                    
                    <div class="features-grid">
                        <!-- Past Projects Card -->
                        <div class="feature-card past-projects-card" onclick="togglePastProjectsPanel()">
                            <div class="feature-icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <div class="feature-content">
                                <h3>
                                    Progetti Salvati 
                                    <span class="projects-count-badge" id="projectsCountBadge" style="display: none;">0</span>
                                    <i class="fas fa-chevron-down expand-icon" id="pastProjectsExpandIcon"></i>
                                </h3>
                                <p>Riutilizza progetti precedenti con le stesse configurazioni</p>
                                
                                <!-- Past Projects Panel (Initially Hidden) -->
                                <div class="past-projects-panel" id="pastProjectsPanel" style="display: none;">
                                    <div class="past-projects-header">
                                        <div class="search-bar">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="projectSearchInput" placeholder="Cerca progetti..." class="search-input">
                                        </div>
                                    </div>
                                    
                                    <!-- Projects List Container -->
                                    <div class="past-projects-list" id="pastProjectsList">
                                        <div class="loading-placeholder">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span>Caricamento progetti...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Empty State -->
                                    <div class="empty-projects-state" id="emptyProjectsState" style="display: none;">
                                        <i class="fas fa-folder-open"></i>
                                        <h4>Nessun progetto presente</h4>
                                        <p>Completa un progetto per salvarlo e poterlo riutilizzare in futuro</p>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="past-projects-actions">
                                        <button class="refresh-btn" onclick="event.stopPropagation(); refreshPastProjects()">
                                            <i class="fas fa-sync-alt"></i> Aggiorna Lista
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </main>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-content">
                <div class="spinner-large"></div>
                <h3 id="loadingTitle">Elaborazione in corso...</h3>
                <p id="loadingMessage">Analisi file SVG e calcolo packing automatico</p>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Fullscreen Preview Modal -->
        <div class="modal-overlay" id="fullscreenModal" style="display: none;">
            <div class="modal-content fullscreen-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-expand"></i> Preview Parete - Schermo Intero</h3>
                    <button type="button" class="btn-icon" id="closeFullscreen">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="fullscreenImage" alt="Preview parete fullscreen">
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js?v=3.0"></script>
    <script src="/static/js/user-section.js?v=3.0"></script>
</body>
</html>